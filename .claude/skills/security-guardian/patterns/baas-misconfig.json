{
  "version": "1.0.0",
  "last_updated": "2026-01-17",
  "description": "Backend-as-a-Service misconfiguration detection patterns",

  "supabase": {
    "name": "Supabase Security Patterns",
    "description": "Based on Escape.tech study: 10.3% of vibe-coded apps have Supabase misconfigurations",
    "patterns": [
      {
        "id": "SUP-CFG-001",
        "name": "RLS possibly disabled",
        "pattern": "(?i)supabase\\.from\\(['\"][^'\"]+['\"]\\)(?!.*rls|.*policy)",
        "severity": "MEDIUM",
        "check_type": "code_pattern",
        "description": "Supabase table query - verify RLS is enabled",
        "remediation": "Enable RLS: ALTER TABLE tablename ENABLE ROW LEVEL SECURITY;",
        "real_world_case": "Lovable platform: 170 apps with RLS disabled"
      },
      {
        "id": "SUP-CFG-002",
        "name": "Service role key in client",
        "pattern": "(?i)(createClient|supabase).*service[_-]?role",
        "severity": "CRITICAL",
        "check_type": "code_pattern",
        "description": "Service role key used in client code bypasses RLS",
        "remediation": "Use anon key for client-side, service_role only on server",
        "real_world_case": "Base44 breach: service_role exposed in frontend"
      },
      {
        "id": "SUP-CFG-003",
        "name": "SELECT * without column restriction",
        "pattern": "(?i)\\.select\\s*\\(['\"]\\*['\"]\\)",
        "severity": "LOW",
        "check_type": "code_pattern",
        "description": "SELECT * may expose unintended columns",
        "remediation": "Explicitly list needed columns: .select('id, name, email')"
      },
      {
        "id": "SUP-CFG-004",
        "name": "Missing auth check before query",
        "pattern": "(?i)supabase\\.from\\((?!.*auth\\.getUser|.*auth\\.getSession)",
        "severity": "MEDIUM",
        "check_type": "code_pattern",
        "description": "Query without verifying user authentication",
        "remediation": "Check auth before queries: const { user } = await supabase.auth.getUser()"
      },
      {
        "id": "SUP-CFG-005",
        "name": "Public storage bucket",
        "pattern": "(?i)(storage\\.from|storageBucket).*public\\s*[:=]\\s*true",
        "severity": "HIGH",
        "check_type": "code_pattern",
        "description": "Storage bucket marked as public",
        "remediation": "Use private buckets with signed URLs for sensitive files"
      },
      {
        "id": "SUP-CFG-006",
        "name": "RPC without auth",
        "pattern": "(?i)\\.rpc\\(['\"][^'\"]+['\"](?!.*auth)",
        "severity": "MEDIUM",
        "check_type": "code_pattern",
        "description": "RPC function call - verify function requires authentication",
        "remediation": "Add SECURITY DEFINER or auth checks to RPC functions"
      },
      {
        "id": "SUP-CFG-007",
        "name": "Exposed Supabase URL",
        "pattern": "https://[a-z0-9]+\\.supabase\\.co",
        "severity": "LOW",
        "check_type": "code_pattern",
        "description": "Supabase project URL in code (informational)",
        "remediation": "URL is semi-public, but use env vars for consistency"
      },
      {
        "id": "SUP-CFG-008",
        "name": "Anon key with elevated permissions",
        "pattern": "(?i)anon.*(?:delete|update|insert)(?!.*rls|.*policy)",
        "severity": "HIGH",
        "check_type": "code_pattern",
        "description": "Write operations with anon key require proper RLS",
        "remediation": "Ensure RLS policies restrict anon key write access"
      }
    ],
    "sql_checks": [
      {
        "id": "SUP-SQL-001",
        "name": "RLS disabled on table",
        "query": "SELECT tablename FROM pg_tables WHERE schemaname = 'public' AND tablename NOT IN (SELECT tablename FROM pg_policies WHERE schemaname = 'public');",
        "severity": "CRITICAL",
        "description": "Tables without Row Level Security policies",
        "remediation": "Add RLS policies to protect data access"
      },
      {
        "id": "SUP-SQL-002",
        "name": "Permissive policy",
        "query": "SELECT * FROM pg_policies WHERE qual = 'true' OR with_check = 'true';",
        "severity": "HIGH",
        "description": "RLS policy allows all access (true)",
        "remediation": "Replace 'true' with proper auth conditions"
      }
    ]
  },

  "firebase": {
    "name": "Firebase Security Patterns",
    "description": "Firebase Realtime Database and Firestore security rules",
    "patterns": [
      {
        "id": "FB-CFG-001",
        "name": "Open read rules",
        "pattern": "(?i)allow\\s+read\\s*:\\s*if\\s+true|\"\\s*\\.read\\s*\"\\s*:\\s*true",
        "severity": "CRITICAL",
        "check_type": "rules_pattern",
        "description": "Firebase rules allow read access to everyone",
        "remediation": "Restrict read access: allow read: if request.auth != null"
      },
      {
        "id": "FB-CFG-002",
        "name": "Open write rules",
        "pattern": "(?i)allow\\s+write\\s*:\\s*if\\s+true|\"\\s*\\.write\\s*\"\\s*:\\s*true",
        "severity": "CRITICAL",
        "check_type": "rules_pattern",
        "description": "Firebase rules allow write access to everyone",
        "remediation": "Restrict write access: allow write: if request.auth != null && request.auth.uid == resource.data.userId"
      },
      {
        "id": "FB-CFG-003",
        "name": "No authentication required",
        "pattern": "(?i)allow\\s+(?:read|write)\\s*:(?!.*auth)",
        "severity": "HIGH",
        "check_type": "rules_pattern",
        "description": "Firebase rule without authentication check",
        "remediation": "Always verify request.auth in security rules"
      },
      {
        "id": "FB-CFG-004",
        "name": "Service account in client",
        "pattern": "(?i)\"type\"\\s*:\\s*\"service_account\"",
        "severity": "CRITICAL",
        "check_type": "code_pattern",
        "description": "Firebase service account credentials in code",
        "remediation": "Service accounts should only be used server-side with GOOGLE_APPLICATION_CREDENTIALS"
      },
      {
        "id": "FB-CFG-005",
        "name": "Admin SDK in client bundle",
        "pattern": "(?i)firebase-admin|@firebase/admin",
        "severity": "CRITICAL",
        "check_type": "code_pattern",
        "description": "Firebase Admin SDK should never be in client code",
        "remediation": "Use Firebase client SDK for frontend, Admin SDK only on server"
      },
      {
        "id": "FB-CFG-006",
        "name": "Realtime Database open",
        "pattern": "(?i)\"rules\"\\s*:\\s*\\{\\s*\"\\.read\"\\s*:\\s*true",
        "severity": "CRITICAL",
        "check_type": "rules_pattern",
        "description": "Realtime Database is publicly readable",
        "remediation": "Add authentication requirements to database rules"
      },
      {
        "id": "FB-CFG-007",
        "name": "Missing validation rules",
        "pattern": "(?i)allow\\s+write(?!.*validate|.*size|.*keys)",
        "severity": "MEDIUM",
        "check_type": "rules_pattern",
        "description": "Write rule without data validation",
        "remediation": "Add validation: allow write: if request.resource.data.keys().hasAll(['field1', 'field2'])"
      },
      {
        "id": "FB-CFG-008",
        "name": "Storage bucket public",
        "pattern": "(?i)allow\\s+read\\s*,\\s*write\\s*;|allow\\s+read\\s*,\\s*write\\s*:\\s*if\\s+true",
        "severity": "CRITICAL",
        "check_type": "rules_pattern",
        "description": "Firebase Storage bucket is publicly accessible",
        "remediation": "Restrict storage access based on authentication and path"
      }
    ],
    "config_files": [
      "firebase.json",
      "firestore.rules",
      "storage.rules",
      "database.rules.json",
      ".firebaserc"
    ]
  },

  "aws_amplify": {
    "name": "AWS Amplify Security Patterns",
    "description": "AWS Amplify authentication and API security",
    "patterns": [
      {
        "id": "AMP-CFG-001",
        "name": "Open GraphQL API",
        "pattern": "(?i)@auth\\s*\\(\\s*rules\\s*:\\s*\\[\\s*\\{\\s*allow\\s*:\\s*public",
        "severity": "HIGH",
        "check_type": "schema_pattern",
        "description": "GraphQL API allows public access",
        "remediation": "Use @auth(rules: [{allow: owner}]) or specific group rules"
      },
      {
        "id": "AMP-CFG-002",
        "name": "Missing auth directive",
        "pattern": "(?i)type\\s+\\w+\\s+@model(?!.*@auth)",
        "severity": "HIGH",
        "check_type": "schema_pattern",
        "description": "Amplify model without @auth directive",
        "remediation": "Add @auth directive to protect data access"
      },
      {
        "id": "AMP-CFG-003",
        "name": "IAM auth for sensitive data",
        "pattern": "(?i)@auth.*allow\\s*:\\s*(?:public|iam).*(?:User|Profile|Account|Payment)",
        "severity": "HIGH",
        "check_type": "schema_pattern",
        "description": "Sensitive model with permissive auth",
        "remediation": "Use owner-based or group-based authorization for sensitive data"
      },
      {
        "id": "AMP-CFG-004",
        "name": "Cognito user pool misconfiguration",
        "pattern": "(?i)\"allowUnauthenticatedIdentities\"\\s*:\\s*true",
        "severity": "MEDIUM",
        "check_type": "config_pattern",
        "description": "Cognito allows unauthenticated identities",
        "remediation": "Disable unauthenticated access unless explicitly needed"
      }
    ],
    "config_files": [
      "amplify/backend/api/*/schema.graphql",
      "amplify/backend/auth/*/parameters.json",
      "aws-exports.js",
      "amplifyconfiguration.json"
    ]
  },

  "pocketbase": {
    "name": "PocketBase Security Patterns",
    "description": "PocketBase collection rules and API security",
    "patterns": [
      {
        "id": "PB-CFG-001",
        "name": "Open list rule",
        "pattern": "(?i)\"listRule\"\\s*:\\s*\"\"",
        "severity": "HIGH",
        "check_type": "config_pattern",
        "description": "PocketBase collection allows listing to everyone",
        "remediation": "Set listRule to require authentication: \"@request.auth.id != ''\""
      },
      {
        "id": "PB-CFG-002",
        "name": "Open view rule",
        "pattern": "(?i)\"viewRule\"\\s*:\\s*\"\"",
        "severity": "HIGH",
        "check_type": "config_pattern",
        "description": "PocketBase collection allows viewing to everyone",
        "remediation": "Restrict viewRule based on ownership or authentication"
      },
      {
        "id": "PB-CFG-003",
        "name": "Open create rule",
        "pattern": "(?i)\"createRule\"\\s*:\\s*\"\"",
        "severity": "CRITICAL",
        "check_type": "config_pattern",
        "description": "PocketBase collection allows anyone to create records",
        "remediation": "Require authentication: \"@request.auth.id != ''\""
      },
      {
        "id": "PB-CFG-004",
        "name": "Open update rule",
        "pattern": "(?i)\"updateRule\"\\s*:\\s*\"\"",
        "severity": "CRITICAL",
        "check_type": "config_pattern",
        "description": "PocketBase collection allows anyone to update records",
        "remediation": "Restrict to owner: \"@request.auth.id = user.id\""
      },
      {
        "id": "PB-CFG-005",
        "name": "Open delete rule",
        "pattern": "(?i)\"deleteRule\"\\s*:\\s*\"\"",
        "severity": "CRITICAL",
        "check_type": "config_pattern",
        "description": "PocketBase collection allows anyone to delete records",
        "remediation": "Restrict to owner or admin"
      }
    ],
    "config_files": [
      "pb_schema.json",
      "pb_data/data.db"
    ]
  },

  "general_baas": {
    "name": "General BaaS Security Patterns",
    "description": "Common patterns across all BaaS platforms",
    "patterns": [
      {
        "id": "BAAS-001",
        "name": "Admin SDK in client code",
        "pattern": "(?i)(firebase-admin|@supabase/supabase-js.*service|adminClient|createServiceClient)",
        "severity": "CRITICAL",
        "description": "Admin/service SDK usage - verify not in client bundle",
        "remediation": "Admin SDKs should only be used in server-side code"
      },
      {
        "id": "BAAS-002",
        "name": "Hardcoded project credentials",
        "pattern": "(?i)(projectId|project_id|apiKey|api_key)\\s*[:=]\\s*['\"][^'\"]+['\"]",
        "severity": "MEDIUM",
        "description": "BaaS project credentials in source",
        "remediation": "Use environment variables for all credentials"
      },
      {
        "id": "BAAS-003",
        "name": "Direct database manipulation",
        "pattern": "(?i)\\.(insert|update|delete|upsert)\\(.*\\)(?!.*validate|.*check|.*verify)",
        "severity": "MEDIUM",
        "description": "Direct database operation without apparent validation",
        "remediation": "Always validate data before database operations"
      },
      {
        "id": "BAAS-004",
        "name": "Missing error handling",
        "pattern": "(?i)(supabase|firebase|amplify)\\.[a-z]+\\((?!.*\\.catch|.*try|.*error)",
        "severity": "LOW",
        "description": "BaaS operation without error handling",
        "remediation": "Always handle errors from async BaaS operations"
      },
      {
        "id": "BAAS-005",
        "name": "Unvalidated file upload",
        "pattern": "(?i)storage\\.(?:upload|from)\\(.*\\)(?!.*type|.*size|.*validate)",
        "severity": "HIGH",
        "description": "File upload without type/size validation",
        "remediation": "Validate file type, size, and content before upload"
      }
    ]
  }
}
